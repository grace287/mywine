{% extends 'base.html' %}
{% load static %}  {# ìƒë‹¨ì— ì¶”ê°€ #}
{% load crispy_forms_tags %}  {# crispy formsë¥¼ ì‚¬ìš©í•˜ëŠ” ê²½ìš° #}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.css' rel='stylesheet' />
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/main.min.js'></script>

<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'css/calendar.css' %}?v=1.1">

<script src="{% static 'js/calendar.js' %}"></script>
<script src="{% static 'js/note_detail.js' %}"></script>
<style>
    td a:after{
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-header">
    <div class="welcome-content">
        <div class="welcome-text">
            <h1>ì•ˆë…•í•˜ì„¸ìš”, {{ user.username }}ë‹˜</h1>
            <p>ì˜¤ëŠ˜ë„ ìƒˆë¡œìš´ ì™€ì¸ì„ ë°œê²¬í•´ë³´ì„¸ìš”</p>
        </div>
        <button id="add-note-btn" class="add-note-button">
            ì‹œìŒë…¸íŠ¸ ì‘ì„±
        </button>
    </div>
    
</div>
<div class="calendar-container">
    

    <h1>ë‚´ ì‹œìŒë…¸íŠ¸</h1>
    <span class="total-count">ì´ {{ recent_notes|length }}ê°œì˜ ë…¸íŠ¸</span>

    <div id='calendar'></div>
    <!-- ì„ íƒëœ ë‚ ì§œì˜ ë…¸íŠ¸ ì„¹ì…˜ -->
    <div id="selected-date-notes" class="notes-preview-section">
        <h3 class="date-title"></h3>
        <div class="notes-cards-container"></div>
    </div>

    <!-- ê°€ì´ë“œ ì„¹ì…˜ ì¶”ê°€ -->
    <div class="guide-section notes-preview-section">
        <div class="guide-content">
            <h2>ë‚˜ë§Œì˜ í…ŒìŠ¤íŒ… ë…¸íŠ¸ë¥¼ ê¸°ë¡í•˜ì„¸ìš”</h2>
            <div class="guide-steps">
                <div class="guide-step">
                    <div class="step-icon">ğŸ“</div>
                    <h3>ì‹œìŒë…¸íŠ¸ ì‘ì„±</h3>
                    <p>ë§ˆì‹  ì™€ì¸ì˜ íŠ¹ì§•ê³¼ ëŠë‚Œì„ ê¸°ë¡í•˜ì„¸ìš”</p>
                </div>
                <div class="guide-step">
                    <div class="step-icon">ğŸ”</div>
                    <h3>ì™€ì¸ ë¶„ì„</h3>
                    <p>ì™€ì¸ì˜ ë§›ê³¼ í–¥ì„ ì²´ê³„ì ìœ¼ë¡œ ë¶„ì„í•˜ì„¸ìš”</p>
                </div>
                <div class="guide-step">
                    <div class="step-icon">ğŸ“Š</div>
                    <h3>ì·¨í–¥ ë°œê²¬</h3>
                    <p>ë‚˜ë§Œì˜ ì™€ì¸ ì·¨í–¥ì„ ë°œê²¬í•˜ì„¸ìš”</p>
                </div>
            </div>
            <!-- <a href="{% url 'notes:note_create' %}" class="create-note-btn">
                <i class="fas fa-plus"></i> ìƒˆ ì‹œìŒë…¸íŠ¸ ì‘ì„±í•˜ê¸°
            </a> -->
        </div>
    </div>

    <!-- ìµœê·¼ ì‹œìŒë…¸íŠ¸ ì˜ˆì‹œ ì„¹ì…˜ -->
    <div class="recent-notes">
        <h2>ìµœê·¼ ì‹œìŒë…¸íŠ¸ ì˜ˆì‹œ</h2>
        <div class="example-note-card">
            <div class="note-header">
                <h3>ì‹œìŒë…¸íŠ¸ ì‘ì„± ì˜ˆì‹œ</h3>
                <span class="wine-type red">ë ˆë“œ ì™€ì¸</span>
            </div>
            <div class="note-content">
                <div class="wine-info">
                    <div class="info-row">
                        <span class="label">ì™€ì¸ëª…</span>
                        <span class="value">ìƒ¤ë˜ ë§ˆê³  2018</span>
                    </div>
                    <div class="info-row">
                        <span class="label">ìƒì‚°êµ­ê°€</span>
                        <span class="value">í”„ë‘ìŠ¤</span>
                    </div>
                </div>
                
                <div class="taste-profile">
                    <h4>ë§› í”„ë¡œí•„</h4>
                    <div class="taste-bars">
                        <div class="taste-bar">
                            <span>ë‹¹ë„</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: 40%"></div>
                            </div>
                        </div>
                        <div class="taste-bar">
                            <span>ì‚°ë„</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: 80%"></div>
                            </div>
                        </div>
                        <div class="taste-bar">
                            <span>ë°”ë””</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="taste-bar">
                            <span>íƒ€ë‹Œ</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: 90%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="note-details">
                    <p class="note-text">ì§„í•œ ë£¨ë¹„ìƒ‰ì„ ë„ë©°, ë¸”ë™ë² ë¦¬ì™€ ì¹´ì‹œìŠ¤ì˜ ì•„ë¡œë§ˆê°€ ëŠê»´ì§‘ë‹ˆë‹¤. 
                    ì…ì•ˆì—ì„œëŠ” í’ë¶€í•œ íƒ€ë‹Œê³¼ í•¨ê»˜ ê¸´ ì—¬ìš´ì´ íŠ¹ì§•ì ì…ë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ìµœê·¼ ë…¸íŠ¸ ì„¹ì…˜ -->
    <!-- <div id="latest-notes" class="notes-preview-section">
        <h3 class="date-title">ìµœê·¼ ì‹œìŒë…¸íŠ¸</h3>
        <div class="notes-cards-container"></div>
    </div> -->
</div>


<!-- note_counts ë°ì´í„°ë¥¼ JavaScriptë¡œ ì „ë‹¬ -->
<script id="note-counts-data" type="application/json">
    {{ note_counts|safe }}
</script>



<!-- ì‹œìŒë…¸íŠ¸ ì‘ì„± ëª¨ë‹¬ -->
<div id="note-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div id="create-note-form">
            <form method="post" action="{% url 'notes:note_create' %}" id="noteForm">
                {% csrf_token %}
                {{ form.as_p }}
                <!-- {% include 'notes/create_note.html' %} -->
                <!-- <button type="submit" class="button">ì €ì¥</button> -->
            </form>
        </div>
    </div>
</div>

<!-- ì‹œìŒë…¸íŠ¸ ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ -->
<div id="note-detail-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="document.getElementById('note-detail-modal').style.display='none'">&times;</span>
        <div class="modal-body">
            <!-- ë…¸íŠ¸ ìƒì„¸ ë‚´ìš©ì€ JavaScriptì—ì„œ ë™ì ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤ -->
            {% include 'notes/note_detail_modal.html' %}
        </div>
    </div>
</div>

<!-- ì‹œìŒë…¸íŠ¸ ëª©ë¡ ëª¨ë‹¬ -->
<div id="notes-list-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 class="modal-title">ì‹œìŒë…¸íŠ¸ ëª©ë¡</h2>
        <div id="notes-list-content"></div>
        <button id="add-note-from-list" class="button primary-button">ìƒˆ ë…¸íŠ¸ ì‘ì„±</button>
    </div>
</div>

<style>
    /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
.calendar-container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 20px;
    display: grid;
    grid-template-columns: 1fr 350px;
    gap: 30px;
}

/* í—¤ë” ìŠ¤íƒ€ì¼ */
.calendar-header {
    background: linear-gradient(135deg, #6c5ce7, #a8e6cf);
    padding: 30px;
    border-radius: 15px;
    margin-bottom: 30px;
    grid-column: 1 / -1;
}

.welcome-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.welcome-text h1 {
    color: white;
    margin-bottom: 10px;
}

.welcome-text p {
    color: rgba(255, 255, 255, 0.9);
}

.add-note-button {
    background: white;
    color: #6c5ce7;
    border: none;
    padding: 12px 25px;
    border-radius: 25px;
    cursor: pointer;
    transition: all 0.3s;
}

/* ìº˜ë¦°ë” ë©”ì¸ ì˜ì—­ */
.calendar-main {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

/* ì‹œìŒë…¸íŠ¸ í”„ë¦¬ë·° ì„¹ì…˜ */
.notes-preview-section {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.date-title {
    margin-bottom: 20px;
    color: #2d3436;
}

/* ë…¸íŠ¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.note-card {
    background: white;
    border: 1px solid #eee;
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 15px;
}

.note-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
}

.wine-badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 0.8em;
}

.wine-badge.red { background: #ff7675; color: white; }
.wine-badge.white { background: #ffeaa7; color: #2d3436; }
.wine-badge.rose { background: #fab1a0; color: white; }
.wine-badge.sparkling { background: #81ecec; color: #2d3436; }

.rating-stars {
    color: #f1c40f;
    margin: 10px 0;
}

.taste-metrics {
    margin: 15px 0;
}

.metric {
    margin-bottom: 8px;
}

.progress-bar {
    background: #eee;
    height: 6px;
    border-radius: 3px;
    margin-top: 5px;
}

.progress {
    background: #6c5ce7;
    height: 100%;
    border-radius: 3px;
}

.detail-btn {
    background: #6c5ce7;
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    width: 100%;
    transition: all 0.2s;
}

/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 1000;
}

.modal-content {
    position: relative;
    background: white;
    width: 90%;
    max-width: 800px;
    margin: 50px auto;
    padding: 30px;
    border-radius: 15px;
    max-height: 90vh;
    overflow-y: auto;
}

.close-button {
    position: absolute;
    top: 20px;
    right: 20px;
    font-size: 1.5em;
    cursor: pointer;
}

/* ë°˜ì‘í˜• ë””ìì¸ */
@media (max-width: 1024px) {
    .calendar-container {
        grid-template-columns: 1fr;
    }

    .notes-preview-section {
        margin-top: 30px;
    }
}

@media (max-width: 768px) {
    .welcome-content {
        flex-direction: column;
        text-align: center;
        gap: 20px;
    }

    .modal-content {
        width: 85%;
        height: auto;
        margin: 20px auto;
    }
}

/* ê°€ì´ë“œ ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
.guide-section {
    background: white;
    padding: 2rem 1rem;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    margin-bottom: 3rem;
}

.guide-content {
    text-align: center;
    max-width: 1200px;
    margin: 0 auto;
}

.guide-steps {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 2rem;
    margin: 2rem 0;
}

.guide-step {
    padding: 1.5rem;
    background: #f8f9fa;
    border-radius: 12px;
    transition: transform 0.2s;
}

.guide-step:hover {
    transform: translateY(-5px);
}

.step-icon {
    font-size: 2.5rem;
    margin-bottom: 1rem;
}

.create-note-btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 1rem 2rem;
    background: #6c5ce7;
    color: white;
    border-radius: 8px;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.2s;
}

.create-note-btn:hover {
    background: #5f3dc4;
}

/* ì˜ˆì‹œ ë…¸íŠ¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
.recent-notes {
    margin-bottom: 3rem;
}

.example-note-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    padding: 2rem;
}

.note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1.5rem;
}

.wine-type {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-size: 0.9rem;
    font-weight: 500;
}

.wine-type.red {
    background: #fee2e2;
    color: #dc2626;
}

.taste-profile {
    margin: 1.5rem 0;
}

.taste-bars {
    display: grid;
    gap: 1rem;
}

.taste-bar {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.bar-container {
    flex: 1;
    height: 8px;
    background: #e5e7eb;
    border-radius: 4px;
    overflow: hidden;
}

.bar-fill {
    height: 100%;
    background: #6c5ce7;
    border-radius: 4px;
}

.note-text {
    color: #4b5563;
    line-height: 1.6;
}

@media (max-width: 768px) {
    .guide-steps {
        grid-template-columns: 1fr;
    }
}
</style>

<!-- ì„ì‹œ. ì‚­ì œì˜ˆì • -->
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    const calendarEvents = JSON.parse(calendarEl.dataset.events);
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth'
        },
        events: function(info, successCallback, failureCallback) {
            const noteCounts = JSON.parse(document.getElementById('note-counts-data').textContent);
            const events = [];
            
            for (let date in noteCounts) {
                events.push({
                    title: `${noteCounts[date]}ê°œ`,
                    start: date,
                    display: 'background',
                    backgroundColor: '#6c5ce7'
                });
            }
            
            successCallback(events);
        },
        dateClick: function(info) {
            const dateStr = info.dateStr;
            const count = noteCounts[dateStr] || 0;

            if (count > 0) {
                showSelectedDateNotes(dateStr);
            } else {
                showNoteModal(dateStr);
            }
        }
    });
    
    calendar.render();

    // ì‘ì„± ëª¨ë‹¬ í‘œì‹œ
    const addNoteBtn = document.getElementById('add-note-btn');
    const createModal = document.getElementById('note-modal');
    
    addNoteBtn.onclick = function() {
        const today = new Date().toISOString().split('T')[0];
        showNoteModal(today);
    }

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ë“¤
    document.querySelectorAll('.close-button').forEach(button => {
        button.onclick = function() {
            this.closest('.modal').style.display = 'none';
        }
    });

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = 'none';
        }
    }
});

// ë…¸íŠ¸ ì‘ì„± ëª¨ë‹¬ í‘œì‹œ
function showNoteModal(date) {
    const modal = document.getElementById('note-modal');
    const dateInput = modal.querySelector('input[name="tasting_date"]');
    if (dateInput) {
        dateInput.value = date;
    }
    modal.style.display = 'block';
}

// ì„ íƒí•œ ë‚ ì§œì˜ ë…¸íŠ¸ í‘œì‹œ
function showSelectedDateNotes(dateStr, containerId = 'selected-date-notes') {
    fetch(`/notes/api/notes/${dateStr}/`)
        .then(response => response.json())
        .then(notes => {
            const container = document.querySelector(`#${containerId} .notes-cards-container`);
            const dateTitle = document.querySelector(`#${containerId} .date-title`);
            
            dateTitle.textContent = `${dateStr} ì‹œìŒë…¸íŠ¸`;
            
            const notesHtml = notes.map(note => `
                <div class="note-card">
                    <div class="note-card-header">
                        <h4>${note.wine_name}</h4>
                        <span class="wine-badge ${note.wine_type.toLowerCase()}">${note.wine_type_display}</span>
                    </div>
                    <div class="rating-stars">
                        ${'â˜…'.repeat(note.rating)}${'â˜†'.repeat(5-note.rating)}
                    </div>
                    <div class="taste-metrics">
                        <div class="metric">
                            <span>ë‹¹ë„</span>
                            <div class="progress-bar">
                                <div class="progress" style="width: ${note.sweetness * 20}%"></div>
                            </div>
                        </div>
                        <div class="metric">
                            <span>ì‚°ë„</span>
                            <div class="progress-bar">
                                <div class="progress" style="width: ${note.acidity * 20}%"></div>
                            </div>
                        </div>
                        <div class="metric">
                            <span>íƒ„ë‹Œ</span>
                            <div class="progress-bar">
                                <div class="progress" style="width: ${note.tannin * 20}%"></div>
                            </div>
                        </div>
                        <div class="metric">
                            <span>ë°”ë””</span>
                            <div class="progress-bar">
                                <div class="progress" style="width: ${note.body * 20}%"></div>
                            </div>
                        </div>
                    </div>
                    <button class="detail-btn" onclick="showNoteDetail(${note.id})">ìƒì„¸ë³´ê¸°</button>
                </div>
            `).join('');
            
            container.innerHTML = notesHtml;
            document.getElementById(containerId).style.display = 'block';
        });
}



// ëª¨ë‹¬ ë‹«ê¸° ì´ë²¤íŠ¸
document.querySelectorAll('.close-button').forEach(button => {
    button.onclick = function() {
        this.closest('.modal').style.display = 'none';
    }
});

window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
} 


<script>
    document.addEventListener("DOMContentLoaded", function () {
    const closeButtons = document.querySelectorAll('.close-button');
    const noteDetailModal = document.getElementById('note-detail-modal');

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    closeButtons.forEach(button => {
        button.addEventListener('click', function () {
            this.closest('.modal').style.display = 'none';
        });
    });

    // ë…¸íŠ¸ ìƒì„¸ë³´ê¸° í•¨ìˆ˜
    window.showNoteDetail = function(noteId) {
        fetch(`/notes/api/note/${noteId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(note => {
            // ë…¸íŠ¸ ì •ë³´ë¥¼ ëª¨ë‹¬ì— ì±„ìš°ê¸°
            // ëª¨ë‹¬ í‘œì‹œ
            const modal = document.getElementById('note-detail-modal');
            modal.style.display = 'block';
            // const modal = document.getElementById('note-detail-modal');
            // const modalBody = modal.querySelector('.modal-body');
            // modalBody.innerHTML = `
            //     <h2>${note.wine_name}</h2>
            //     <p><strong>ì™€ì´ë„ˆë¦¬:</strong> ${note.winery}</p>
            //     <p><strong>ë¹ˆí‹°ì§€:</strong> ${note.vintage}</p>
            //     <p><strong>ì™€ì¸ ì¢…ë¥˜:</strong> ${note.wine_type}</p>
            //     <p><strong>ì‹œìŒ ë‚ ì§œ:</strong> ${note.tasting_date}</p>
            //     <p><strong>ì „ì²´ í‰ê°€:</strong> ${note.overall}</p>
            //     <p><strong>ë‹¹ë„:</strong> ${note.sweetness}</p>
            //     <p><strong>ì‚°ë„:</strong> ${note.acidity}</p>
            //     <p><strong>íƒ„ë‹Œ:</strong> ${note.tannin}</p>
            //     <p><strong>ë°”ë””:</strong> ${note.body}</p>
            // `;
            modal.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    };

    // ë…¸íŠ¸ ì‘ì„± í¼ ì œì¶œ ì²˜ë¦¬
    const noteForm = document.getElementById('noteForm');
    if (noteForm) {
        noteForm.addEventListener('submit', function(event) {
            event.preventDefault(); // ê¸°ë³¸ ì œì¶œ ë°©ì§€
            const formData = new FormData(noteForm);

            fetch(noteForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.errors || 'ë…¸íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                if (data.redirect_url) {
                    window.location.href = data.redirect_url; // ë¦¬ë‹¤ì´ë ‰íŠ¸
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        });
    }
});
</script>
<script>
    document.getElementById('noteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNoteDetail(data.note_id);
                createModal.style.display = "none";
                calendar.refetchEvents();  // ë‹¬ë ¥ ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨
            // ë…¸íŠ¸ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            window.location.href = `/notes/note/${data.note_id}/`;
        } else {
            alert('ë…¸íŠ¸ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
});
    document.addEventListener('DOMContentLoaded', function() {
        // note_counts ë°ì´í„°ë¥¼ JavaScript ê°ì²´ë¡œ ë³€í™˜
        const noteCounts = JSON.parse('{{ note_counts|escapejs }}');
        // console.log('Note counts:', noteCounts);  // ë””ë²„ê¹…ìš©

        // í˜ì´ì§€ ë¡œë“œì‹œ ê°€ì¥ ìµœê·¼ ë‚ ì§œì˜ ë…¸íŠ¸ í‘œì‹œ
        const latestDate = Object.keys(noteCounts).sort().reverse()[0];
        if (latestDate) {
            showSelectedDateNotes(latestDate, 'latest-notes');
        }

        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
            },
            events: function(info, successCallback, failureCallback) {
                const noteCounts = {{ note_counts|safe }};
                const events = [];
                
                for (let date in noteCounts) {
                    events.push({
                        title: `${noteCounts[date]}ê°œ`,
                        start: date,
                        display: 'background',
                        backgroundColor: '#6c5ce7'
                    });
            }
            
            successCallback(events);
        },
            dayCellDidMount: function(arg) {
            const dateStr = arg.date.toISOString().split('T')[0];
            const count = noteCounts[dateStr] || 0;
            
            if (count > 0) {
                const countElement = document.createElement('div');
                countElement.className = 'note-count';
                countElement.textContent = count;
                arg.el.querySelector('.fc-daygrid-day-top').appendChild(countElement);
            }
        },
            dayCellContent: function(arg) {
                const dateStr = arg.date.toISOString().split('T')[0];
                const count = window.noteCounts?.[dateStr] || 0;
                
                return {
                    html: `
                        <div class="date-content">
                            <span class="date-number">${arg.dayNumberText}</span>
                            ${count > 0 ? `<span class="note-count">${count}</span>` : ''}
                        </div>
                    `
                };
            },
            dateClick: function(info) {
            const dateStr = info.dateStr;
            const count = noteCounts[dateStr] || 0;

            console.log('Date clicked:', dateStr);
            console.log('Note count:', count);  

            if (noteCounts[dateStr]) {
                showSelectedDateNotes(dateStr, 'selected-date-notes');
            }
            
            if (count > 0) {
                // í•´ë‹¹ ë‚ ì§œì˜ ë…¸íŠ¸ ëª©ë¡ì„ ëª¨ë‹¬ë¡œ í‘œì‹œ
                showNotesListModal(dateStr);
            } else {
                // ìƒˆ ë…¸íŠ¸ ì‘ì„± ëª¨ë‹¬ í‘œì‹œ
                showNoteModal(dateStr);
            }
        }
        });
        
        calendar.render();
        
        // ëª¨ë‹¬ ì œì–´
        const modal = document.getElementById('note-modal');
        const closeBtn = document.querySelector('.close-button');
        const addNoteBtn = document.getElementById('add-note-btn');
        const createModal = document.getElementById('note-modal');
        const listModal = document.getElementById('notes-list-modal');
        const closeButtons = document.querySelectorAll('.close-button');
        const addNoteFromListBtn = document.getElementById('add-note-from-list');
        const detailModal = document.getElementById('note-detail-modal');


        // ëª¨ë‹¬ ì—´ê¸°
        addNoteBtn.onclick = function() {
            const today = new Date().toISOString().split('T')[0];
            showNoteModal(today);
        }

        // ëª¨ë‹¬ ë‹«ê¸°
    closeBtn.onclick = function() {
        modal.style.display = "none";
    }

    // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ë“¤
    closeButtons.forEach(button => {
        button.onclick = function() {
            createModal.style.display = "none";
            listModal.style.display = "none";
            detailModal.style.display = "none";
        }
    });

    // ìƒˆ ë…¸íŠ¸ ì‘ì„± ë²„íŠ¼
    addNoteBtn.onclick = function() {
        const today = new Date().toISOString().split('T')[0];
        showNoteModal(today);
    }

    // ëª©ë¡ì—ì„œ ìƒˆ ë…¸íŠ¸ ì‘ì„± ë²„íŠ¼
    addNoteFromListBtn.onclick = function() {
        listModal.style.display = "none";
        const dateStr = listModal.getAttribute('data-date');
        showNoteModal(dateStr);
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
        if (event.target == createModal || event.target == listModal) {
            createModal.style.display = "none";
            listModal.style.display = "none";
            detailModal.style.display = "none";
        }
    }

    // ë‚ ì§œ í´ë¦­ ì´ë²¤íŠ¸ ìˆ˜ì •
calendar.setOption('dateClick', function(info) {
    const dateStr = info.dateStr;
    const count = noteCounts[dateStr] || 0;
    
    if (count > 0) {
        showSelectedDateNotes(dateStr);
    } else {
        showNoteModal(dateStr);
    }
});

// ì„ íƒí•œ ë‚ ì§œì˜ ë…¸íŠ¸ í‘œì‹œ í•¨ìˆ˜
function showSelectedDateNotes(dateStr) {
    const container = document.querySelector('.notes-cards-container');
    const dateTitle = document.querySelector('.date-title');
    dateTitle.textContent = `${dateStr} ì‹œìŒë…¸íŠ¸`;
    
    fetch(`/notes/api/notes/${dateStr}/`)
        .then(response => response.json())
        .then(notes => {
            const notesHtml = notes.map(note => `
                <div class="note-card">
                    <div class="note-card-header">
                        <h4>${note.wine_name}</h4>
                        <span class="wine-badge ${note.wine_type.toLowerCase()}">${note.wine_type_display}</span>
                    </div>
                    <div class="note-card-body">
                        <div class="rating-stars">
                            ${'â˜…'.repeat(note.rating)}${'â˜†'.repeat(5-note.rating)}
                            <span class="rating-text">${note.rating}/5</span>
                        </div>
                        <div class="taste-metrics">
                            <div class="metric">
                                <span>ë‹¹ë„</span>
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${note.sweetness * 20}%"></div>
                                </div>
                            </div>
                            <div class="metric">
                                <span>ì‚°ë„</span>
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${note.acidity * 20}%"></div>
                                </div>
                            </div>
                            <div class="metric">
                                <span>íƒ„ë‹Œ</span>
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${note.tannin * 20}%"></div>
                                </div>
                            </div>
                            <div class="metric">
                                <span>ë°”ë””</span>
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${note.body * 20}%"></div>
                                </div>
                            </div>
                        </div>
                        <button class="detail-btn show-note-detail" onclick="showNoteDetail(${note.id})">ë…¸íŠ¸ ìƒì„¸ë³´ê¸°</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = notesHtml;
            document.getElementById('selected-date-notes').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = '<p class="error-message">ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
        });
}

    // ìƒˆ ë…¸íŠ¸ ì‘ì„± ëª¨ë‹¬ í‘œì‹œ
    function showNoteModal(date) {
        const modal = document.getElementById('note-modal');
        const dateInput = modal.querySelector('input[name="tasting_date"]');
        if (dateInput) {
            dateInput.value = date;
        }
        modal.style.display = "block";
    }

    function showNoteDetail(noteId) {
        const detailModal = document.getElementById('note-detail-modal');
        const contentDiv = document.getElementById('note-detail-content');
        
        fetch(`/notes/api/note/${noteId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                return response.json();
            })
            .then(note => {
                contentDiv.innerHTML = `
                    <div class="note-detail">
                        <div class="note-header">
                            <h2>${note.wine_name}</h2>
                            <div class="note-meta">
                                <span class="wine-type">${note.wine_type_display}</span>
                                <span class="rating">${'â˜…'.repeat(note.rating)}</span>
                            </div>
                        </div>

                        <div class="note-content">
                            <div class="wine-info-section">
                                <h3>ì™€ì¸ ì •ë³´</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>ì™€ì´ë„ˆë¦¬</label>
                                        <span>${note.winery}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>ë¹ˆí‹°ì§€</label>
                                        <span>${note.vintage}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="tasting-profile">
                                <h3>í…Œì´ìŠ¤íŒ… í”„ë¡œí•„</h3>
                                <div class="taste-grid">
                                    <div class="taste-item">
                                        <label>ë‹¹ë„</label>
                                        <div class="taste-bar">
                                            <div class="taste-level" style="width: ${note.sweetness * 20}%"></div>
                                        </div>
                                    </div>
                                    <div class="taste-item">
                                        <label>ì‚°ë„</label>
                                        <div class="taste-bar">
                                            <div class="taste-level" style="width: ${note.acidity * 20}%"></div>
                                        </div>
                                    </div>
                                    <div class="taste-item">
                                        <label>íƒ„ë‹Œ</label>
                                        <div class="taste-bar">
                                            <div class="taste-level" style="width: ${note.tannin * 20}%"></div>
                                        </div>
                                    </div>
                                    <div class="taste-item">
                                        <label>ë°”ë””</label>
                                        <div class="taste-bar">
                                            <div class="taste-level" style="width: ${note.body * 20}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tasting-notes">
                                <h3>í…Œì´ìŠ¤íŒ… ë…¸íŠ¸</h3>
                                <div class="notes-grid">
                                    <div class="note-item">
                                        <label>ì™¸ê´€</label>
                                        <p>${note.appearance_clarity} / ${note.appearance_intensity}</p>
                                    </div>
                                    <div class="note-item">
                                        <label>ì•„ë¡œë§ˆ</label>
                                        <p>${note.aroma_intensity} / ${note.aroma_notes}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="overall-note">
                                <h3>ì¢…í•© í‰ê°€</h3>
                                <p>${note.overall}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                detailModal.style.display = "block";
            })
            .catch(error => {
                console.error('Error:', error);
                contentDiv.innerHTML = '<p class="error-message">ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
    }

    function deleteNote(noteId) {
        if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            fetch(`/notes/${noteId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('note-detail-modal').style.display = "none";
                    calendar.refetchEvents();  // ë‹¬ë ¥ ì´ë²¤íŠ¸ ìƒˆë¡œê³ ì¹¨
                } else {
                    alert('ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            });
        }
    }
    function showNotesListModal(dateStr) {
        const modal = document.getElementById('notes-list-modal');
        const contentDiv = document.getElementById('notes-list-content');
        
        // ëª¨ë‹¬ íƒ€ì´í‹€ ì—…ë°ì´íŠ¸
        const modalTitle = modal.querySelector('.modal-title');
        modalTitle.textContent = `${dateStr} ì‹œìŒë…¸íŠ¸`;
        
        fetch(`/notes/api/notes/${dateStr}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // ì‘ë‹µ ë°ì´í„° ë¡œê¹…
                console.log('API Response:', data);
                
                // ë°ì´í„°ê°€ ë¹„ì–´ìˆëŠ” ê²½ìš° ì²˜ë¦¬
                if (!Array.isArray(data) || data.length === 0) {
                    contentDiv.innerHTML = '<p class="no-notes">ì´ ë‚ ì§œì˜ ì‹œìŒë…¸íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                    return;
                }

                // ë…¸íŠ¸ ëª©ë¡ ìƒì„±
                const notesHtml = data.map((note, index) => `
                    <div class="note-preview ${index === 0 ? 'active' : ''}">
                        <div class="note-preview-header" onclick="toggleNotePreview(${note.id})">
                            <div class="note-basic-info">
                                <h3>${note.wine_name}</h3>
                                <span class="wine-type">${note.wine_type_display}</span>
                            </div>
                            <div class="note-rating">
                                <span class="stars">${'â˜…'.repeat(note.rating)}</span>
                                <span class="rating-number">${note.rating}/5</span>
                                <span class="toggle-icon">${index === 0 ? 'â–¼' : 'â–¶'}</span>
                            </div>
                        </div>
                        
                        <div class="note-preview-content" id="note-content-${note.id}">
                            <div class="taste-metrics">
                                <div class="metric">
                                    <span class="label">ë‹¹ë„</span>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${note.sweetness * 20}%"></div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <span class="label">ì‚°ë„</span>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${note.acidity * 20}%"></div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <span class="label">íƒ„ë‹Œ</span>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${note.tannin * 20}%"></div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <span class="label">ë°”ë””</span>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${note.body * 20}%"></div>
                                    </div>
                                </div>
                            </div>
                            <button class="view-detail-btn" onclick="showNoteDetail(${note.id})">
                                ìƒì„¸ë³´ê¸°
                            </button>
                        </div>
                    </div>
                `).join('');

                contentDiv.innerHTML = `
                    <div class="notes-accordion">
                        ${notesHtml}
                    </div>
                    <button onclick="showNoteModal('${dateStr}')" class="add-note-button">
                        ìƒˆ ë…¸íŠ¸ ì‘ì„±
                    </button>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                contentDiv.innerHTML = '<p class="error-message">ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
            });
        
        modal.style.display = "block";
    }

    function toggleNotePreview(noteId) {
        const preview = document.querySelector(`#note-content-${noteId}`).closest('.note-preview');
        const icon = preview.querySelector('.toggle-icon');
        const allPreviews = document.querySelectorAll('.note-preview');
        
        // ë‹¤ë¥¸ ëª¨ë“  í”„ë¦¬ë·°ë¥¼ ë‹«ìŒ
        allPreviews.forEach(p => {
            if (p !== preview) {
                p.classList.remove('active');
                p.querySelector('.toggle-icon').textContent = 'â–¶';
            }
        });
        
        // í˜„ì¬ ë…¸íŠ¸ì˜ ìƒíƒœë¥¼ í† ê¸€
        preview.classList.toggle('active');
        icon.textContent = preview.classList.contains('active') ? 'â–¼' : 'â–¶';
    }
        // ë…¸íŠ¸ ëª©ë¡ ëª¨ë‹¬ í‘œì‹œ
    // function showNotesListModal(date) {
    //     const modal = document.getElementById('notes-list-modal');
    //     const contentDiv = document.getElementById('notes-list-content');
    //     modal.setAttribute('data-date', date);
        
    //     // AJAXë¡œ í•´ë‹¹ ë‚ ì§œì˜ ë…¸íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    //     fetch(`/notes/by-date/${date}/`)
    //         .then(response => response.json())
    //         .then(data => {
    //             let html = `<h3>${date} ì‹œìŒë…¸íŠ¸</h3>`;
    //             data.notes.forEach(note => {
    //                 html += `
    //                     <div class="note-card">
    //                         <div class="note-wine">
    //                             <strong>${note.wine_name}</strong>
    //                             ${note.winery ? `<span class="note-winery">(${note.winery})</span>` : ''}
    //                         </div>
    //                         <div class="note-info">
    //                             <span class="note-type">${note.wine_type_display}</span>
    //                             <span class="note-rating">${'â˜…'.repeat(note.rating)}</span>
    //                         </div>
    //                         <div class="note-actions">
    //                             <a href="/notes/note/${note.id}/" class="button">ìƒì„¸ë³´ê¸°</a>
    //                         </div>
    //                     </div>
    //                 `;
    //             });
    //             contentDiv.innerHTML = html;
    //         })
    //         .catch(error => {
    //             console.error('Error:', error);
    //             contentDiv.innerHTML = '<p>ë…¸íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>';
    //         });
    
    //     modal.style.display = "block";
    // }
        
        function showCreateNoteModal(date) {
            const dateInput = document.querySelector('input[name="tasting_date"]');
            if (dateInput) dateInput.value = date;
            modal.style.display = 'block';
        }
        // ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
        function showNoteModal(date) {
            const modal = document.getElementById('note-modal');
            const dateInput = modal.querySelector('input[name="tasting_date"]');
            if (dateInput) {
                dateInput.value = date;
            }
            modal.style.display = "block";
        }
        function hideModal() {
            modal.style.display = 'none';
        }
        
        addNoteBtn.addEventListener('click', () => {
            const today = new Date().toISOString().split('T')[0];
            showCreateNoteModal(today);
        });
        
        closeBtn.addEventListener('click', hideModal);
        
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideModal();
            }
        });
    });
</script>

<!-- detail -->
 <!-- JavaScript -->


{% endblock %}