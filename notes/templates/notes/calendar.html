{% extends 'base.html' %}
{% load static %}  {# μƒλ‹¨μ— μ¶”κ°€ #}
{% load crispy_forms_tags %}  {# crispy formsλ¥Ό μ‚¬μ©ν•λ” κ²½μ° #}

{% block extra_head %}
<!-- FullCalendar CSS -->
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.css' rel='stylesheet' />
<link href='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.css' rel='stylesheet' />
<!-- FullCalendar JS -->
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.8/main.min.js'></script>
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.8/main.min.js'></script>

<!-- Custom CSS -->
<link rel="stylesheet" href="{% static 'css/calendar.css' %}?v=1.1">

<script src="{% static 'js/calendar.js' %}"></script>
<script src="{% static 'js/note_detail.js' %}"></script>
<style>
    td a:after{
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="calendar-header">
    <div class="welcome-content">
        <div class="welcome-text">
            <h1>μ•λ…•ν•μ„Έμ”, {{ user.username }}λ‹</h1>
            <p>μ¤λλ„ μƒλ΅μ΄ μ™€μΈμ„ λ°κ²¬ν•΄λ³΄μ„Έμ”</p>
        </div>
        <button id="add-note-btn" class="add-note-button">
            μ‹μλ…ΈνΈ μ‘μ„±
        </button>
    </div>
    
</div>
<div class="calendar-container">
    

    <h1>λ‚΄ μ‹μλ…ΈνΈ</h1>
    <span class="total-count">μ΄ {{ recent_notes|length }}κ°μ λ…ΈνΈ</span>

    <div id='calendar'></div>
    <!-- μ„ νƒλ λ‚ μ§μ λ…ΈνΈ μ„Ήμ… -->
    <div id="selected-date-notes" class="notes-preview-section">
        <h3 class="date-title"></h3>
        <div class="notes-cards-container"></div>
    </div>

    <!-- κ°€μ΄λ“ μ„Ήμ… μ¶”κ°€ -->
    <div class="guide-section notes-preview-section">
        <div class="guide-content">
            <h2>λ‚λ§μ ν…μ¤ν… λ…ΈνΈλ¥Ό κΈ°λ΅ν•μ„Έμ”</h2>
            <div class="guide-steps">
                <div class="guide-step">
                    <div class="step-icon">π“</div>
                    <h3>μ‹μλ…ΈνΈ μ‘μ„±</h3>
                    <p>λ§μ‹  μ™€μΈμ νΉμ§•κ³Ό λλ‚μ„ κΈ°λ΅ν•μ„Έμ”</p>
                </div>
                <div class="guide-step">
                    <div class="step-icon">π”</div>
                    <h3>μ™€μΈ λ¶„μ„</h3>
                    <p>μ™€μΈμ λ§›κ³Ό ν–¥μ„ μ²΄κ³„μ μΌλ΅ λ¶„μ„ν•μ„Έμ”</p>
                </div>
                <div class="guide-step">
                    <div class="step-icon">π“</div>
                    <h3>μ·¨ν–¥ λ°κ²¬</h3>
                    <p>λ‚λ§μ μ™€μΈ μ·¨ν–¥μ„ λ°κ²¬ν•μ„Έμ”</p>
                </div>
            </div>
            <!-- <a href="{% url 'notes:note_create' %}" class="create-note-btn">
                <i class="fas fa-plus"></i> μƒ μ‹μλ…ΈνΈ μ‘μ„±ν•κΈ°
            </a> -->
        </div>
    </div>

    <!-- μµκ·Ό μ‹μλ…ΈνΈ μμ‹ μ„Ήμ… -->
    <div class="recent-notes">
        <h2>μµκ·Ό μ‹μλ…ΈνΈ μμ‹</h2>
        <div class="example-note-card">
            <div class="note-header">
                <h3>μ‹μλ…ΈνΈ μ‘μ„± μμ‹</h3>
                <span class="wine-type red">λ λ“ μ™€μΈ</span>
            </div>
            <div class="note-content">
                <div class="wine-info">
                    <div class="info-row">
                        <span class="label">μ™€μΈλ…</span>
                        <span class="value">μƒ¤λ λ§κ³  2018</span>
                    </div>
                    <div class="info-row">
                        <span class="label">μƒμ‚°κµ­κ°€</span>
                        <span class="value">ν”„λ‘μ¤</span>
                    </div>
                </div>
                
                <div class="taste-profile">
                    <h4>λ§› ν”„λ΅ν•„</h4>
                    <div class="taste-bars">
                        <div class="taste-bar">
                            <span>λ‹Ήλ„</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: 40%"></div>
                            </div>
                        </div>
                        <div class="taste-bar">
                            <span>μ‚°λ„</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: 80%"></div>
                            </div>
                        </div>
                        <div class="taste-bar">
                            <span>λ°”λ””</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: 100%"></div>
                            </div>
                        </div>
                        <div class="taste-bar">
                            <span>νƒ€λ‹</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: 90%"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="note-details">
                    <p class="note-text">μ§„ν• λ£¨λΉ„μƒ‰μ„ λ„λ©°, λΈ”λ™λ² λ¦¬μ™€ μΉ΄μ‹μ¤μ μ•„λ΅λ§κ°€ λκ»΄μ§‘λ‹λ‹¤. 
                    μ…μ•μ—μ„λ” ν’λ¶€ν• νƒ€λ‹κ³Ό ν•¨κ» κΈ΄ μ—¬μ΄μ΄ νΉμ§•μ μ…λ‹λ‹¤.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- μµκ·Ό λ…ΈνΈ μ„Ήμ… -->
    <!-- <div id="latest-notes" class="notes-preview-section">
        <h3 class="date-title">μµκ·Ό μ‹μλ…ΈνΈ</h3>
        <div class="notes-cards-container"></div>
    </div> -->
</div>


<!-- note_counts λ°μ΄ν„°λ¥Ό JavaScriptλ΅ μ „λ‹¬ -->
<script id="note-counts-data" type="application/json">
    {{ note_counts|safe }}
</script>



<!-- μ‹μλ…ΈνΈ μ‘μ„± λ¨λ‹¬ -->
<div id="note-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <div id="create-note-form">
            <form method="post" action="{% url 'notes:note_create' %}" id="noteForm">
                {% csrf_token %}
                {{ form.as_p }}
                <!-- {% include 'notes/create_note.html' %} -->
                <!-- <button type="submit" class="button">μ €μ¥</button> -->
            </form>
        </div>
    </div>
</div>

<!-- μ‹μλ…ΈνΈ μƒμ„Έ λ³΄κΈ° λ¨λ‹¬ -->
<div id="note-detail-modal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="document.getElementById('note-detail-modal').style.display='none'">&times;</span>
        <div class="modal-body">
            <!-- λ…ΈνΈ μƒμ„Έ λ‚΄μ©μ€ JavaScriptμ—μ„ λ™μ μΌλ΅ μ±„μ›μ§‘λ‹λ‹¤ -->
            {% include 'notes/note_detail_modal.html' %}
        </div>
    </div>
</div>

<!-- μ‹μλ…ΈνΈ λ©λ΅ λ¨λ‹¬ -->
<div id="notes-list-modal" class="modal">
    <div class="modal-content">
        <span class="close-button">&times;</span>
        <h2 class="modal-title">μ‹μλ…ΈνΈ λ©λ΅</h2>
        <div id="notes-list-content"></div>
        <button id="add-note-from-list" class="button primary-button">μƒ λ…ΈνΈ μ‘μ„±</button>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    const closeButtons = document.querySelectorAll('.close-button');
    const noteDetailModal = document.getElementById('note-detail-modal');

    // λ¨λ‹¬ λ‹«κΈ° λ²„νΌ μ΄λ²¤νΈ λ¦¬μ¤λ„
    closeButtons.forEach(button => {
        button.addEventListener('click', function () {
            this.closest('.modal').style.display = 'none';
        });
    });

    // λ…ΈνΈ μƒμ„Έλ³΄κΈ° ν•¨μ
    window.showNoteDetail = function(noteId) {
        fetch(`/notes/api/note/${noteId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('λ…ΈνΈλ¥Ό λ¶λ¬μ¤λ” λ° μ‹¤ν¨ν–μµλ‹λ‹¤.');
                }
                return response.json();
            })
            .then(note => {
            // λ…ΈνΈ μ •λ³΄λ¥Ό λ¨λ‹¬μ— μ±„μ°κΈ°
            // λ¨λ‹¬ ν‘μ‹
            const modal = document.getElementById('note-detail-modal');
            modal.style.display = 'block';
            // const modal = document.getElementById('note-detail-modal');
            // const modalBody = modal.querySelector('.modal-body');
            // modalBody.innerHTML = `
            //     <h2>${note.wine_name}</h2>
            //     <p><strong>μ™€μ΄λ„λ¦¬:</strong> ${note.winery}</p>
            //     <p><strong>λΉν‹°μ§€:</strong> ${note.vintage}</p>
            //     <p><strong>μ™€μΈ μΆ…λ¥:</strong> ${note.wine_type}</p>
            //     <p><strong>μ‹μ λ‚ μ§:</strong> ${note.tasting_date}</p>
            //     <p><strong>μ „μ²΄ ν‰κ°€:</strong> ${note.overall}</p>
            //     <p><strong>λ‹Ήλ„:</strong> ${note.sweetness}</p>
            //     <p><strong>μ‚°λ„:</strong> ${note.acidity}</p>
            //     <p><strong>νƒ„λ‹:</strong> ${note.tannin}</p>
            //     <p><strong>λ°”λ””:</strong> ${note.body}</p>
            // `;
            modal.style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            alert('λ…ΈνΈλ¥Ό λ¶λ¬μ¤λ” λ° μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
        });
    };

    // λ…ΈνΈ μ‘μ„± νΌ μ μ¶ μ²λ¦¬
    const noteForm = document.getElementById('noteForm');
    if (noteForm) {
        noteForm.addEventListener('submit', function(event) {
            event.preventDefault(); // κΈ°λ³Έ μ μ¶ λ°©μ§€
            const formData = new FormData(noteForm);

            fetch(noteForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(data => {
                        throw new Error(data.errors || 'λ…ΈνΈ μ €μ¥μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
                    });
                }
                return response.json();
            })
            .then(data => {
                alert(data.message);
                if (data.redirect_url) {
                    window.location.href = data.redirect_url; // λ¦¬λ‹¤μ΄λ ‰νΈ
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert(error.message);
            });
        });
    }
});
</script>
<script>
    document.getElementById('noteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    
    fetch(this.action, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': formData.get('csrfmiddlewaretoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNoteDetail(data.note_id);
                createModal.style.display = "none";
                calendar.refetchEvents();  // λ‹¬λ ¥ μ΄λ²¤νΈ μƒλ΅κ³ μΉ¨
            // λ…ΈνΈ μƒμ„Έ νμ΄μ§€λ΅ μ΄λ™
            window.location.href = `/notes/note/${data.note_id}/`;
        } else {
            alert('λ…ΈνΈ μ €μ¥μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.');
    });
});
    document.addEventListener('DOMContentLoaded', function() {
        // note_counts λ°μ΄ν„°λ¥Ό JavaScript κ°μ²΄λ΅ λ³€ν™
        const noteCounts = JSON.parse('{{ note_counts|escapejs }}');
        // console.log('Note counts:', noteCounts);  // λ””λ²„κΉ…μ©

        // νμ΄μ§€ λ΅λ“μ‹ κ°€μ¥ μµκ·Ό λ‚ μ§μ λ…ΈνΈ ν‘μ‹
        const latestDate = Object.keys(noteCounts).sort().reverse()[0];
        if (latestDate) {
            showSelectedDateNotes(latestDate, 'latest-notes');
        }

        var calendarEl = document.getElementById('calendar');
        var calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            locale: 'ko',
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: 'dayGridMonth'
            },
            events: function(info, successCallback, failureCallback) {
                const noteCounts = {{ note_counts|safe }};
                const events = [];
                
                for (let date in noteCounts) {
                    events.push({
                        title: `${noteCounts[date]}κ°`,
                        start: date,
                        display: 'background',
                        backgroundColor: '#6c5ce7'
                    });
            }
            
            successCallback(events);
        },
            dayCellDidMount: function(arg) {
            const dateStr = arg.date.toISOString().split('T')[0];
            const count = noteCounts[dateStr] || 0;
            
            if (count > 0) {
                const countElement = document.createElement('div');
                countElement.className = 'note-count';
                countElement.textContent = count;
                arg.el.querySelector('.fc-daygrid-day-top').appendChild(countElement);
            }
        },
            dayCellContent: function(arg) {
                const dateStr = arg.date.toISOString().split('T')[0];
                const count = window.noteCounts?.[dateStr] || 0;
                
                return {
                    html: `
                        <div class="date-content">
                            <span class="date-number">${arg.dayNumberText}</span>
                            ${count > 0 ? `<span class="note-count">${count}</span>` : ''}
                        </div>
                    `
                };
            },
            dateClick: function(info) {
            const dateStr = info.dateStr;
            const count = noteCounts[dateStr] || 0;

            console.log('Date clicked:', dateStr);
            console.log('Note count:', count);  

            if (noteCounts[dateStr]) {
                showSelectedDateNotes(dateStr, 'selected-date-notes');
            }
            
            if (count > 0) {
                // ν•΄λ‹Ή λ‚ μ§μ λ…ΈνΈ λ©λ΅μ„ λ¨λ‹¬λ΅ ν‘μ‹
                showNotesListModal(dateStr);
            } else {
                // μƒ λ…ΈνΈ μ‘μ„± λ¨λ‹¬ ν‘μ‹
                showNoteModal(dateStr);
            }
        }
        });
        
        calendar.render();
        
        // λ¨λ‹¬ μ μ–΄
        const modal = document.getElementById('note-modal');
        const closeBtn = document.querySelector('.close-button');
        const addNoteBtn = document.getElementById('add-note-btn');
        const createModal = document.getElementById('note-modal');
        const listModal = document.getElementById('notes-list-modal');
        const closeButtons = document.querySelectorAll('.close-button');
        const addNoteFromListBtn = document.getElementById('add-note-from-list');
        const detailModal = document.getElementById('note-detail-modal');


        // λ¨λ‹¬ μ—΄κΈ°
        addNoteBtn.onclick = function() {
            const today = new Date().toISOString().split('T')[0];
            showNoteModal(today);
        }

        // λ¨λ‹¬ λ‹«κΈ°
    closeBtn.onclick = function() {
        modal.style.display = "none";
    }

    // λ¨λ‹¬ λ‹«κΈ° λ²„νΌλ“¤
    closeButtons.forEach(button => {
        button.onclick = function() {
            createModal.style.display = "none";
            listModal.style.display = "none";
            detailModal.style.display = "none";
        }
    });

    // μƒ λ…ΈνΈ μ‘μ„± λ²„νΌ
    addNoteBtn.onclick = function() {
        const today = new Date().toISOString().split('T')[0];
        showNoteModal(today);
    }

    // λ©λ΅μ—μ„ μƒ λ…ΈνΈ μ‘μ„± λ²„νΌ
    addNoteFromListBtn.onclick = function() {
        listModal.style.display = "none";
        const dateStr = listModal.getAttribute('data-date');
        showNoteModal(dateStr);
    }

    // λ¨λ‹¬ μ™Έλ¶€ ν΄λ¦­ μ‹ λ‹«κΈ°
    window.onclick = function(event) {
        if (event.target == createModal || event.target == listModal) {
            createModal.style.display = "none";
            listModal.style.display = "none";
            detailModal.style.display = "none";
        }
    }

    // λ‚ μ§ ν΄λ¦­ μ΄λ²¤νΈ μμ •
calendar.setOption('dateClick', function(info) {
    const dateStr = info.dateStr;
    const count = noteCounts[dateStr] || 0;
    
    if (count > 0) {
        showSelectedDateNotes(dateStr);
    } else {
        showNoteModal(dateStr);
    }
});

// μ„ νƒν• λ‚ μ§μ λ…ΈνΈ ν‘μ‹ ν•¨μ
function showSelectedDateNotes(dateStr) {
    const container = document.querySelector('.notes-cards-container');
    const dateTitle = document.querySelector('.date-title');
    dateTitle.textContent = `${dateStr} μ‹μλ…ΈνΈ`;
    
    fetch(`/notes/api/notes/${dateStr}/`)
        .then(response => response.json())
        .then(notes => {
            const notesHtml = notes.map(note => `
                <div class="note-card">
                    <div class="note-card-header">
                        <h4>${note.wine_name}</h4>
                        <span class="wine-badge ${note.wine_type.toLowerCase()}">${note.wine_type_display}</span>
                    </div>
                    <div class="note-card-body">
                        <div class="rating-stars">
                            ${'β…'.repeat(note.rating)}${'β†'.repeat(5-note.rating)}
                            <span class="rating-text">${note.rating}/5</span>
                        </div>
                        <div class="taste-metrics">
                            <div class="metric">
                                <span>λ‹Ήλ„</span>
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${note.sweetness * 20}%"></div>
                                </div>
                            </div>
                            <div class="metric">
                                <span>μ‚°λ„</span>
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${note.acidity * 20}%"></div>
                                </div>
                            </div>
                            <div class="metric">
                                <span>νƒ„λ‹</span>
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${note.tannin * 20}%"></div>
                                </div>
                            </div>
                            <div class="metric">
                                <span>λ°”λ””</span>
                                <div class="progress-bar">
                                    <div class="progress" style="width: ${note.body * 20}%"></div>
                                </div>
                            </div>
                        </div>
                        <button class="detail-btn show-note-detail" onclick="showNoteDetail(${note.id})">λ…ΈνΈ μƒμ„Έλ³΄κΈ°</button>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = notesHtml;
            document.getElementById('selected-date-notes').style.display = 'block';
        })
        .catch(error => {
            console.error('Error:', error);
            container.innerHTML = '<p class="error-message">λ…ΈνΈλ¥Ό λ¶λ¬μ¤λ” μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.</p>';
        });
}

    // μƒ λ…ΈνΈ μ‘μ„± λ¨λ‹¬ ν‘μ‹
    function showNoteModal(date) {
        const modal = document.getElementById('note-modal');
        const dateInput = modal.querySelector('input[name="tasting_date"]');
        if (dateInput) {
            dateInput.value = date;
        }
        modal.style.display = "block";
    }

    function showNoteDetail(noteId) {
        const detailModal = document.getElementById('note-detail-modal');
        const contentDiv = document.getElementById('note-detail-content');
        
        fetch(`/notes/api/note/${noteId}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('λ…ΈνΈλ¥Ό λ¶λ¬μ¤λ”λ° μ‹¤ν¨ν–μµλ‹λ‹¤.');
                }
                return response.json();
            })
            .then(note => {
                contentDiv.innerHTML = `
                    <div class="note-detail">
                        <div class="note-header">
                            <h2>${note.wine_name}</h2>
                            <div class="note-meta">
                                <span class="wine-type">${note.wine_type_display}</span>
                                <span class="rating">${'β…'.repeat(note.rating)}</span>
                            </div>
                        </div>

                        <div class="note-content">
                            <div class="wine-info-section">
                                <h3>μ™€μΈ μ •λ³΄</h3>
                                <div class="info-grid">
                                    <div class="info-item">
                                        <label>μ™€μ΄λ„λ¦¬</label>
                                        <span>${note.winery}</span>
                                    </div>
                                    <div class="info-item">
                                        <label>λΉν‹°μ§€</label>
                                        <span>${note.vintage}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="tasting-profile">
                                <h3>ν…μ΄μ¤ν… ν”„λ΅ν•„</h3>
                                <div class="taste-grid">
                                    <div class="taste-item">
                                        <label>λ‹Ήλ„</label>
                                        <div class="taste-bar">
                                            <div class="taste-level" style="width: ${note.sweetness * 20}%"></div>
                                        </div>
                                    </div>
                                    <div class="taste-item">
                                        <label>μ‚°λ„</label>
                                        <div class="taste-bar">
                                            <div class="taste-level" style="width: ${note.acidity * 20}%"></div>
                                        </div>
                                    </div>
                                    <div class="taste-item">
                                        <label>νƒ„λ‹</label>
                                        <div class="taste-bar">
                                            <div class="taste-level" style="width: ${note.tannin * 20}%"></div>
                                        </div>
                                    </div>
                                    <div class="taste-item">
                                        <label>λ°”λ””</label>
                                        <div class="taste-bar">
                                            <div class="taste-level" style="width: ${note.body * 20}%"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="tasting-notes">
                                <h3>ν…μ΄μ¤ν… λ…ΈνΈ</h3>
                                <div class="notes-grid">
                                    <div class="note-item">
                                        <label>μ™Έκ΄€</label>
                                        <p>${note.appearance_clarity} / ${note.appearance_intensity}</p>
                                    </div>
                                    <div class="note-item">
                                        <label>μ•„λ΅λ§</label>
                                        <p>${note.aroma_intensity} / ${note.aroma_notes}</p>
                                    </div>
                                </div>
                            </div>

                            <div class="overall-note">
                                <h3>μΆ…ν•© ν‰κ°€</h3>
                                <p>${note.overall}</p>
                            </div>
                        </div>
                    </div>
                `;
                
                detailModal.style.display = "block";
            })
            .catch(error => {
                console.error('Error:', error);
                contentDiv.innerHTML = '<p class="error-message">λ…ΈνΈλ¥Ό λ¶λ¬μ¤λ” μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.</p>';
            });
    }

    function deleteNote(noteId) {
        if (confirm('μ •λ§ μ‚­μ ν•μ‹κ² μµλ‹κΉ?')) {
            fetch(`/notes/${noteId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
            .then(response => {
                if (response.ok) {
                    document.getElementById('note-detail-modal').style.display = "none";
                    calendar.refetchEvents();  // λ‹¬λ ¥ μ΄λ²¤νΈ μƒλ΅κ³ μΉ¨
                } else {
                    alert('μ‚­μ μ— μ‹¤ν¨ν–μµλ‹λ‹¤.');
                }
            });
        }
    }
    function showNotesListModal(dateStr) {
        const modal = document.getElementById('notes-list-modal');
        const contentDiv = document.getElementById('notes-list-content');
        
        // λ¨λ‹¬ νƒ€μ΄ν‹€ μ—…λ°μ΄νΈ
        const modalTitle = modal.querySelector('.modal-title');
        modalTitle.textContent = `${dateStr} μ‹μλ…ΈνΈ`;
        
        fetch(`/notes/api/notes/${dateStr}/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // μ‘λ‹µ λ°μ΄ν„° λ΅κΉ…
                console.log('API Response:', data);
                
                // λ°μ΄ν„°κ°€ λΉ„μ–΄μλ” κ²½μ° μ²λ¦¬
                if (!Array.isArray(data) || data.length === 0) {
                    contentDiv.innerHTML = '<p class="no-notes">μ΄ λ‚ μ§μ μ‹μλ…ΈνΈκ°€ μ—†μµλ‹λ‹¤.</p>';
                    return;
                }

                // λ…ΈνΈ λ©λ΅ μƒμ„±
                const notesHtml = data.map((note, index) => `
                    <div class="note-preview ${index === 0 ? 'active' : ''}">
                        <div class="note-preview-header" onclick="toggleNotePreview(${note.id})">
                            <div class="note-basic-info">
                                <h3>${note.wine_name}</h3>
                                <span class="wine-type">${note.wine_type_display}</span>
                            </div>
                            <div class="note-rating">
                                <span class="stars">${'β…'.repeat(note.rating)}</span>
                                <span class="rating-number">${note.rating}/5</span>
                                <span class="toggle-icon">${index === 0 ? 'β–Ό' : 'β–¶'}</span>
                            </div>
                        </div>
                        
                        <div class="note-preview-content" id="note-content-${note.id}">
                            <div class="taste-metrics">
                                <div class="metric">
                                    <span class="label">λ‹Ήλ„</span>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${note.sweetness * 20}%"></div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <span class="label">μ‚°λ„</span>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${note.acidity * 20}%"></div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <span class="label">νƒ„λ‹</span>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${note.tannin * 20}%"></div>
                                    </div>
                                </div>
                                <div class="metric">
                                    <span class="label">λ°”λ””</span>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${note.body * 20}%"></div>
                                    </div>
                                </div>
                            </div>
                            <button class="view-detail-btn" onclick="showNoteDetail(${note.id})">
                                μƒμ„Έλ³΄κΈ°
                            </button>
                        </div>
                    </div>
                `).join('');

                contentDiv.innerHTML = `
                    <div class="notes-accordion">
                        ${notesHtml}
                    </div>
                    <button onclick="showNoteModal('${dateStr}')" class="add-note-button">
                        μƒ λ…ΈνΈ μ‘μ„±
                    </button>
                `;
            })
            .catch(error => {
                console.error('Error:', error);
                contentDiv.innerHTML = '<p class="error-message">λ…ΈνΈλ¥Ό λ¶λ¬μ¤λ” μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.</p>';
            });
        
        modal.style.display = "block";
    }

    function toggleNotePreview(noteId) {
        const preview = document.querySelector(`#note-content-${noteId}`).closest('.note-preview');
        const icon = preview.querySelector('.toggle-icon');
        const allPreviews = document.querySelectorAll('.note-preview');
        
        // λ‹¤λ¥Έ λ¨λ“  ν”„λ¦¬λ·°λ¥Ό λ‹«μ
        allPreviews.forEach(p => {
            if (p !== preview) {
                p.classList.remove('active');
                p.querySelector('.toggle-icon').textContent = 'β–¶';
            }
        });
        
        // ν„μ¬ λ…ΈνΈμ μƒνƒλ¥Ό ν† κΈ€
        preview.classList.toggle('active');
        icon.textContent = preview.classList.contains('active') ? 'β–Ό' : 'β–¶';
    }
        // λ…ΈνΈ λ©λ΅ λ¨λ‹¬ ν‘μ‹
    // function showNotesListModal(date) {
    //     const modal = document.getElementById('notes-list-modal');
    //     const contentDiv = document.getElementById('notes-list-content');
    //     modal.setAttribute('data-date', date);
        
    //     // AJAXλ΅ ν•΄λ‹Ή λ‚ μ§μ λ…ΈνΈ λ©λ΅ κ°€μ Έμ¤κΈ°
    //     fetch(`/notes/by-date/${date}/`)
    //         .then(response => response.json())
    //         .then(data => {
    //             let html = `<h3>${date} μ‹μλ…ΈνΈ</h3>`;
    //             data.notes.forEach(note => {
    //                 html += `
    //                     <div class="note-card">
    //                         <div class="note-wine">
    //                             <strong>${note.wine_name}</strong>
    //                             ${note.winery ? `<span class="note-winery">(${note.winery})</span>` : ''}
    //                         </div>
    //                         <div class="note-info">
    //                             <span class="note-type">${note.wine_type_display}</span>
    //                             <span class="note-rating">${'β…'.repeat(note.rating)}</span>
    //                         </div>
    //                         <div class="note-actions">
    //                             <a href="/notes/note/${note.id}/" class="button">μƒμ„Έλ³΄κΈ°</a>
    //                         </div>
    //                     </div>
    //                 `;
    //             });
    //             contentDiv.innerHTML = html;
    //         })
    //         .catch(error => {
    //             console.error('Error:', error);
    //             contentDiv.innerHTML = '<p>λ…ΈνΈλ¥Ό λ¶λ¬μ¤λ” μ¤‘ μ¤λ¥κ°€ λ°μƒν–μµλ‹λ‹¤.</p>';
    //         });
    
    //     modal.style.display = "block";
    // }
        
        function showCreateNoteModal(date) {
            const dateInput = document.querySelector('input[name="tasting_date"]');
            if (dateInput) dateInput.value = date;
            modal.style.display = 'block';
        }
        // λ¨λ‹¬ ν‘μ‹ ν•¨μ
        function showNoteModal(date) {
            const modal = document.getElementById('note-modal');
            const dateInput = modal.querySelector('input[name="tasting_date"]');
            if (dateInput) {
                dateInput.value = date;
            }
            modal.style.display = "block";
        }
        function hideModal() {
            modal.style.display = 'none';
        }
        
        addNoteBtn.addEventListener('click', () => {
            const today = new Date().toISOString().split('T')[0];
            showCreateNoteModal(today);
        });
        
        closeBtn.addEventListener('click', hideModal);
        
        window.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideModal();
            }
        });
    });
</script>

<!-- detail -->
 <!-- JavaScript -->


{% endblock %}